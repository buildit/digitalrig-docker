= K8S version of Jenkins-based CD pipeline.

== Prereqs

* Minikube
* kubectl

== Installation

1. Build `images/jenkins-master/build.sh`
1. Build `images/nodejs/build.sh`
1. Apply k8s configs `kubectl apply -f .`
1. Add host records to use name-based ingress routing
----
echo "`minikube ip`  traefik.kube.local jenkins.kube.local sample.kube.local" > /etc/hosts`
----

== Principles

* We're using Traefik as k8s ingress controller
* There are two ingress controllers private (available within VPC) and public (exposed using external ELB)
* All resources are available on private ingress contoller
* Resources matching selector `realm=public` are available on public ingress controller

== Usage

1. Jenkins is available on http://jenkins.kube.local
1. Traefik web console is available on http://traefik.kube.local

== Example job

[code,groovy]
----
podTemplate(label: 'nodeapp',
            containers: [
                containerTemplate(name: 'nodejs-builder', image: 'rig/k8s/nodejs', ttyEnabled: true, command: 'cat', privileged: true),
                containerTemplate(name: 'docker', image: 'docker:1.11', ttyEnabled: true, command: 'cat'),
                containerTemplate(name: 'kubectl', image: 'lachlanevenson/k8s-kubectl', ttyEnabled: true, command: 'cat')],
            volumes: [
                hostPathVolume(mountPath: '/var/gitrepo', hostPath: '/Users/romansafronov/dev/projects/digitalrig-acceptance-tests'),
                hostPathVolume(mountPath: '/var/run/docker.sock', hostPath: '/var/run/docker.sock')]) {
    node('nodeapp') {
        def nextVersion = new Date().time as String
        container('nodejs-builder') {
            stage('Checkout') {
                git(url: 'file:///var/gitrepo')
            }
            stage('Build') {
                sh 'cd ./src/test/apps/node-docker && ls -l && npm install && npm run dist'
            }
        }

        container('docker') {
            stage('Package') {
                sh "cd ./src/test/apps/node-docker && docker build -t my-environment:${nextVersion} ."
            }
        }
        container('kubectl') {
            stage('Deploy') {
                sh "kubectl set image deployment/sample-node-app-deployment sample-node-app=my-environment:$nextVersion"
                sh 'kubectl rollout status deployment/sample-node-app-deployment'
            }
        }
        container('nodejs-builder') {
            stage('e2e test') {
                //nasty workaround for temporary chrome socket issue (can't use remote mount for it)
                sh "mkdir /tmp/wscopy && cd ./src/test/apps/node-docker && ls -1 | xargs -I '{}'  ln -s `pwd`/{} /tmp/wscopy/{}"
                sh "cd /tmp/wscopy && URL=http://sample-node-app-svc# xvfb-run --server-args='-screen 0, 1024x768x16'  npm run test:e2e"
            }
        }

        // TODO: ROLLBACK RELEASE ON FAILURE??
    }
}
----
